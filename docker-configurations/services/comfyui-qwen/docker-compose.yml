services:
  comfyui-qwen:
    image: python:3.11
    container_name: comfyui-qwen
    hostname: comfyui-qwen
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['${GPU_DEVICE_ID:-0}']
              capabilities: [gpu]
    
    ports:
      - "${COMFYUI_PORT:-8188}:8188"
    
    volumes:
      - type: bind
        source: ${COMFYUI_WORKSPACE_PATH:-./workspace}
        target: /workspace/ComfyUI
      - type: bind
        source: ../../shared/models
        target: /workspace/ComfyUI/models
      - type: bind
        source: ../../shared/cache
        target: /workspace/ComfyUI/cache
      - type: bind
        source: ../../shared/outputs
        target: /workspace/ComfyUI/output
      - type: bind
        source: ../../../.secrets/qwen-api-user.token
        target: /workspace/ComfyUI/.secrets/qwen-api-user.token
        read_only: true
      - type: bind
        source: ./entrypoint.sh
        target: /entrypoint.sh
    
    environment:
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-0}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=${TZ:-Europe/Paris}
      - COMFYUI_PORT=8188
      - COMFYUI_LISTEN=0.0.0.0
      # Tokens pour téléchargement des modèles
      - CIVITAI_TOKEN=${CIVITAI_TOKEN}
      - HF_TOKEN=${HF_TOKEN}
      - QWEN_API_TOKEN=${QWEN_API_TOKEN}
      # Configuration authentification ComfyUI-Login
      - COMFYUI_LOGIN_ENABLED=${COMFYUI_LOGIN_ENABLED:-true}
      - COMFYUI_USERNAME=${COMFYUI_USERNAME}
      - COMFYUI_PASSWORD=${COMFYUI_PASSWORD}
      - COMFYUI_BEARER_TOKEN=${COMFYUI_BEARER_TOKEN}
      - GUEST_MODE_ENABLED=${GUEST_MODE_ENABLED:-false}
      - SECRET_KEY=${SECRET_KEY}
      # Configuration comportement
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - VERBOSE_LOGGING=${VERBOSE_LOGGING:-false}
      - API_TIMEOUT=${API_TIMEOUT:-30}
      - MAX_LOGIN_ATTEMPTS=${MAX_LOGIN_ATTEMPTS:-3}
      - SESSION_EXPIRE_HOURS=${SESSION_EXPIRE_HOURS:-24}
    
    working_dir: /workspace/ComfyUI
    
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    
    healthcheck:
      # Verification TCP simple car l'API requiert authentification Bearer
      # Le code HTTP 401 indique que le serveur fonctionne (auth requise)
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8188/ | grep -qE '200|401'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    
    restart: unless-stopped
    
    networks:
      - comfyui-network
    
    labels:
      - "com.myia.service=comfyui-qwen"
      - "com.myia.gpu=rtx-3090"
      - "com.myia.model=qwen-image-edit-2509"
      - "com.myia.phase=production-secure"

networks:
  comfyui-network:
    driver: bridge
    name: comfyui-network

# Les volumes sont maintenant gérés par le système de volumes partagés
# Pas de volumes locaux nécessaires - utilisation des bind mounts vers shared/