services:
  comfyui-qwen:
    image: nvidia/cuda:12.4.0-devel-ubuntu22.04
    container_name: comfyui-qwen-no-auth
    hostname: comfyui-qwen
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
      
    ports:
      - "8188:8188"
      
    volumes:
      - type: bind
        source: ./workspace
        target: /workspace/ComfyUI
      
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=Europe/Paris
      - COMFYUI_PORT=8188
      - COMFYUI_LISTEN=0.0.0.0
      # Tokens pour téléchargement des modèles
      - CIVITAI_TOKEN=c39ba121e12e5b40ac67a87836431e34
      - HF_TOKEN=HF_TOKEN_REDACTED
      - QWEN_API_TOKEN=2%=tVJ6@!Nc(7#VTvj-Bh3^nm0WY-Lij
      
    working_dir: /workspace/ComfyUI
    
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq --no-install-recommends python3 python3-pip python3-venv git curl wget ca-certificates &&
        apt-get clean &&
        rm -rf /var/lib/apt/lists/* &&
        cd /workspace &&
        # Cloner ComfyUI si le répertoire n'existe pas ou est vide
        if [ ! -d ComfyUI ] || [ ! -f ComfyUI/main.py ]; then
          echo 'Clonage de ComfyUI depuis GitHub...' &&
          rm -rf ComfyUI 2>/dev/null || true &&
          sleep 2 &&
          git clone https://github.com/comfyanonymous/ComfyUI.git --depth 1
        fi &&
        cd /workspace/ComfyUI &&
        if [ ! -d venv ]; then
          echo 'Création du venv et installation des dépendances...' &&
          python3 -m venv venv &&
          venv/bin/pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124 &&
          venv/bin/pip install -r requirements.txt
        fi &&
        exec venv/bin/python3 main.py --listen 0.0.0.0 --port 8188 --preview-method auto --use-split-cross-attention
      "
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    
    restart: unless-stopped
    
    networks:
      - comfyui-network
    
    labels:
      - "com.myia.service=comfyui-qwen-test"
      - "com.myia.gpu=rtx-3090"
      - "com.myia.model=qwen-image-edit-2509"
      - "com.myia.phase=11-validation"
      

networks:
  comfyui-network:
    driver: bridge
    name: comfyui-network