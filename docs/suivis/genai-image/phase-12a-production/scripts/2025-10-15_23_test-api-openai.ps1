# Test API OpenAI Compatible - ComfyUI + Forge
# Date: 2025-10-15 23:53 UTC
# Objectif: V√©rifier et documenter les APIs disponibles

param(
    [string]$ComfyUIBaseUrl = "https://qwen-image-edit.myia.io",
    [string]$ForgeBaseUrl = "https://turbo.stable-diffusion-webui-forge.myia.io",
    [string]$OutputDir = "d:/Dev/CoursIA/docs/genai-suivis"
)

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë      Test API OpenAI Compatible - Phase 12A              ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan

$apiReport = @{
    Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
    ComfyUI = @{
        BaseUrl = $ComfyUIBaseUrl
        Endpoints = @{}
    }
    Forge = @{
        BaseUrl = $ForgeBaseUrl
        Endpoints = @{}
    }
}

# ============================================================================
# PHASE 2.2: V√©rification Endpoints ComfyUI
# ============================================================================

Write-Host "‚ïê‚ïê‚ïê Phase 2.2: Endpoints API ComfyUI ‚ïê‚ïê‚ïê`n" -ForegroundColor Yellow

$comfyEndpoints = @(
    @{ Path = "/system_stats"; Method = "GET"; Description = "Statistiques syst√®me" }
    @{ Path = "/queue"; Method = "GET"; Description = "√âtat de la queue" }
    @{ Path = "/history"; Method = "GET"; Description = "Historique des prompts" }
    @{ Path = "/prompt"; Method = "POST"; Description = "Soumettre un prompt" }
    @{ Path = "/object_info"; Method = "GET"; Description = "Info objets ComfyUI" }
    @{ Path = "/extensions"; Method = "GET"; Description = "Extensions install√©es" }
    @{ Path = "/v1/completions"; Method = "POST"; Description = "OpenAI completions (si disponible)" }
    @{ Path = "/v1/chat/completions"; Method = "POST"; Description = "OpenAI chat completions (si disponible)" }
    @{ Path = "/api/v1/completions"; Method = "POST"; Description = "API completions (si disponible)" }
)

foreach ($endpoint in $comfyEndpoints) {
    Write-Host "üìä Test: $($endpoint.Path) [$($endpoint.Method)]" -ForegroundColor Cyan
    Write-Host "   Description: $($endpoint.Description)" -ForegroundColor Gray
    
    try {
        if ($endpoint.Method -eq "GET") {
            $response = Invoke-WebRequest -Uri "$ComfyUIBaseUrl$($endpoint.Path)" `
                -Method Get `
                -UseBasicParsing `
                -TimeoutSec 10 `
                -ErrorAction Stop
            
            Write-Host "   ‚úÖ Accessible - Status: $($response.StatusCode)" -ForegroundColor Green
            
            $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "Available"
                StatusCode = $response.StatusCode
                ContentType = $response.Headers['Content-Type']
                Description = $endpoint.Description
            }
        }
        elseif ($endpoint.Method -eq "POST") {
            # Pour POST, on teste juste si l'endpoint r√©pond (m√™me avec erreur 400)
            $response = Invoke-WebRequest -Uri "$ComfyUIBaseUrl$($endpoint.Path)" `
                -Method Post `
                -Body "{}" `
                -ContentType "application/json" `
                -UseBasicParsing `
                -TimeoutSec 10 `
                -ErrorAction SilentlyContinue
            
            if ($response) {
                Write-Host "   ‚úÖ Endpoint r√©pond - Status: $($response.StatusCode)" -ForegroundColor Green
                $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                    Method = $endpoint.Method
                    Status = "Available"
                    StatusCode = $response.StatusCode
                    Description = $endpoint.Description
                }
            }
        }
    }
    catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        
        if ($statusCode -eq 405) {
            Write-Host "   ‚ö†Ô∏è M√©thode $($endpoint.Method) non support√©e" -ForegroundColor Yellow
            $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "MethodNotAllowed"
                StatusCode = 405
                Description = $endpoint.Description
            }
        }
        elseif ($statusCode -eq 404) {
            Write-Host "   ‚ùå Non trouv√© (404)" -ForegroundColor Red
            $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "NotFound"
                StatusCode = 404
                Description = $endpoint.Description
            }
        }
        elseif ($statusCode -eq 400) {
            Write-Host "   ‚ö†Ô∏è Endpoint existe mais requ√™te invalide (400)" -ForegroundColor Yellow
            $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "RequiresValidRequest"
                StatusCode = 400
                Description = $endpoint.Description
            }
        }
        else {
            Write-Host "   ‚ö†Ô∏è Erreur: $($_.Exception.Message)" -ForegroundColor Yellow
            $apiReport.ComfyUI.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "Error"
                Message = $_.Exception.Message
                Description = $endpoint.Description
            }
        }
    }
    
    Start-Sleep -Milliseconds 200
}

# ============================================================================
# PHASE 2.3: V√©rification API Forge
# ============================================================================

Write-Host "`n`n‚ïê‚ïê‚ïê Phase 2.3: API Forge ‚ïê‚ïê‚ïê`n" -ForegroundColor Yellow

$forgeEndpoints = @(
    @{ Path = "/docs"; Method = "GET"; Description = "Documentation API Swagger" }
    @{ Path = "/sdapi/v1/txt2img"; Method = "POST"; Description = "G√©n√©ration text-to-image" }
    @{ Path = "/sdapi/v1/img2img"; Method = "POST"; Description = "G√©n√©ration image-to-image" }
    @{ Path = "/sdapi/v1/options"; Method = "GET"; Description = "Options de configuration" }
    @{ Path = "/sdapi/v1/sd-models"; Method = "GET"; Description = "Mod√®les disponibles" }
    @{ Path = "/sdapi/v1/samplers"; Method = "GET"; Description = "Samplers disponibles" }
)

foreach ($endpoint in $forgeEndpoints) {
    Write-Host "üìä Test: $($endpoint.Path) [$($endpoint.Method)]" -ForegroundColor Cyan
    Write-Host "   Description: $($endpoint.Description)" -ForegroundColor Gray
    
    try {
        if ($endpoint.Method -eq "GET") {
            $response = Invoke-WebRequest -Uri "$ForgeBaseUrl$($endpoint.Path)" `
                -Method Get `
                -UseBasicParsing `
                -TimeoutSec 10 `
                -ErrorAction Stop
            
            Write-Host "   ‚úÖ Accessible - Status: $($response.StatusCode)" -ForegroundColor Green
            
            $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "Available"
                StatusCode = $response.StatusCode
                ContentType = $response.Headers['Content-Type']
                Description = $endpoint.Description
            }
        }
        elseif ($endpoint.Method -eq "POST") {
            # Test minimal pour txt2img
            if ($endpoint.Path -eq "/sdapi/v1/txt2img") {
                $testBody = @{
                    prompt = "test"
                    steps = 1
                    width = 512
                    height = 512
                } | ConvertTo-Json
                
                $response = Invoke-WebRequest -Uri "$ForgeBaseUrl$($endpoint.Path)" `
                    -Method Post `
                    -Body $testBody `
                    -ContentType "application/json" `
                    -UseBasicParsing `
                    -TimeoutSec 30 `
                    -ErrorAction SilentlyContinue
                
                if ($response) {
                    Write-Host "   ‚úÖ API g√©n√©ration fonctionnelle - Status: $($response.StatusCode)" -ForegroundColor Green
                    $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                        Method = $endpoint.Method
                        Status = "Functional"
                        StatusCode = $response.StatusCode
                        Description = $endpoint.Description
                        Note = "Test√© avec requ√™te minimale"
                    }
                }
            }
            else {
                # Pour les autres POST, on teste juste la pr√©sence
                Write-Host "   ‚ö†Ô∏è Endpoint POST non test√© en d√©tail" -ForegroundColor Yellow
                $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                    Method = $endpoint.Method
                    Status = "NotTested"
                    Description = $endpoint.Description
                }
            }
        }
    }
    catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        
        if ($statusCode -eq 404) {
            Write-Host "   ‚ùå Non trouv√© (404)" -ForegroundColor Red
            $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "NotFound"
                StatusCode = 404
                Description = $endpoint.Description
            }
        }
        elseif ($statusCode -eq 400 -or $statusCode -eq 422) {
            Write-Host "   ‚ö†Ô∏è Endpoint existe mais requ√™te invalide ($statusCode)" -ForegroundColor Yellow
            $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "RequiresValidRequest"
                StatusCode = $statusCode
                Description = $endpoint.Description
            }
        }
        else {
            Write-Host "   ‚ö†Ô∏è Erreur: $($_.Exception.Message)" -ForegroundColor Yellow
            $apiReport.Forge.Endpoints[$endpoint.Path] = @{
                Method = $endpoint.Method
                Status = "Error"
                Message = $_.Exception.Message
                Description = $endpoint.Description
            }
        }
    }
    
    Start-Sleep -Milliseconds 200
}

# ============================================================================
# Sauvegarde et R√©sum√©
# ============================================================================

Write-Host "`n`n‚ïê‚ïê‚ïê Sauvegarde R√©sultats API ‚ïê‚ïê‚ïê`n" -ForegroundColor Yellow

$reportPath = "$OutputDir/2025-10-15_23_rapport-test-api.json"
$apiReport | ConvertTo-Json -Depth 10 | Out-File $reportPath -Encoding UTF8

Write-Host "‚úÖ Rapport API sauvegard√©: 2025-10-15_23_rapport-test-api.json" -ForegroundColor Green

# Statistiques
$comfyAvailable = ($apiReport.ComfyUI.Endpoints.Values | Where-Object { $_.Status -eq "Available" }).Count
$comfyTotal = $apiReport.ComfyUI.Endpoints.Count
$forgeAvailable = ($apiReport.Forge.Endpoints.Values | Where-Object { $_.Status -eq "Available" -or $_.Status -eq "Functional" }).Count
$forgeTotal = $apiReport.Forge.Endpoints.Count

Write-Host "`n`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë                    R√âSUM√â TESTS API                       ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan

Write-Host "üìä ComfyUI API:" -ForegroundColor Yellow
Write-Host "   Endpoints disponibles: $comfyAvailable / $comfyTotal" -ForegroundColor White

Write-Host "`nüìä Forge API:" -ForegroundColor Yellow
Write-Host "   Endpoints disponibles: $forgeAvailable / $forgeTotal" -ForegroundColor White

Write-Host "`n‚úÖ Test des APIs termin√©`n" -ForegroundColor Green